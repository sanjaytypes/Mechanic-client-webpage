<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mechanic on the Way</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="styles-client.css">
</head>
<body onload="initMap()">

    <div class="search-container">
        <h2 id="status-text">üîç Searching for Mechanic...</h2>
        <div class="loader"></div>

        <div id="map"></div>

        <p id="eta-info"></p>
    </div>

    <script>
        let map, clientMarker, mechanicMarker, routeLine;
        let mechanicLat = 13.0827; // Example starting location (Chennai)
        let mechanicLon = 80.2707;

        function initMap() {
            const clientLat = parseFloat(localStorage.getItem("latitude"));
            const clientLon = parseFloat(localStorage.getItem("longitude"));

            if (!clientLat || !clientLon) {
                alert("‚ö†Ô∏è Location not found! Returning to issue page.");
                window.location.href = "issue-report.html";
                return;
            }

            map = L.map("map").setView([clientLat, clientLon], 13);

            // Load OpenStreetMap tiles
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                attribution: "&copy; OpenStreetMap contributors"
            }).addTo(map);

            // Client Marker
            clientMarker = L.marker([clientLat, clientLon])
                .addTo(map)
                .bindPopup("üìç Client Location")
                .openPopup();

            // Mechanic Marker
            mechanicMarker = L.marker([mechanicLat, mechanicLon], {
                icon: L.icon({
                    iconUrl: "https://cdn-icons-png.flaticon.com/512/847/847969.png",
                    iconSize: [30, 30]
                })
            }).addTo(map).bindPopup("üõ† Mechanic Location");

            findMechanic();
        }

        function findMechanic() {
            setTimeout(() => {
                document.getElementById("status-text").innerHTML = "‚úÖ Mechanic Found! Tracking live location...";
                document.querySelector(".loader").style.display = "none";

                updateMechanicLocation();
                setInterval(updateMechanicLocation, 5000);
            }, 5000);
        }

        function updateMechanicLocation() {
            mechanicLat += 0.001; // Simulating movement
            mechanicLon += 0.001;

            mechanicMarker.setLatLng([mechanicLat, mechanicLon]);

            // Draw route using OpenRouteService API (if needed)
            if (routeLine) map.removeLayer(routeLine);
            routeLine = L.polyline([[mechanicLat, mechanicLon], [clientMarker.getLatLng().lat, clientMarker.getLatLng().lng]], {
                color: "blue",
                weight: 4,
                opacity: 0.7
            }).addTo(map);

            // Update distance & ETA (approximate)
            const distance = getDistance(mechanicLat, mechanicLon, clientMarker.getLatLng().lat, clientMarker.getLatLng().lng);
            const eta = Math.max(1, Math.round(distance / 0.5)); // Assuming 30km/h speed

            document.getElementById("eta-info").innerHTML = `üöó Mechanic is ${distance.toFixed(1)} km away. ETA: ${eta} min`;
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of Earth in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in km
        }
    </script>

</body>
</html>
